Cleaned up code a little bit.  Improved the error handling.
